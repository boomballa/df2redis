# æ¶æ„æ€»è§ˆ

df2redis æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¤åˆ¶å·¥å…·ï¼Œå®ç°äº† Dragonfly çš„åŸç”Ÿå¤åˆ¶åè®®ï¼Œæ”¯æŒå®æ—¶æ•°æ®è¿ç§»åˆ° Redis/Redis Clusterã€‚

## è®¾è®¡åŸåˆ™

### 1. é›¶åœæœºè¿ç§»
- **å…¨é‡åŒæ­¥**ï¼šåŸºäºå¿«ç…§çš„æ‰¹é‡æ•°æ®ä¼ è¾“ï¼ˆRDB æ ¼å¼ï¼‰
- **å¢é‡åŒæ­¥**ï¼šæŒç»­çš„ Journal æµé‡æ”¾å®ç°å®æ—¶æ›´æ–°
- **æ— ç¼åˆ‡æ¢**ï¼šå…¨å±€åŒæ­¥å±éšœç¡®ä¿é˜¶æ®µåˆ‡æ¢æ—¶ä¸ä¸¢å¤±æ•°æ®

### 2. é«˜æ€§èƒ½
- **å¤š FLOW å¹¶è¡Œ**ï¼šå¹¶è¡Œæ•°æ®æµåŒ¹é… Dragonfly çš„åˆ†ç‰‡æ•°é‡ï¼ˆN ä¸ºæºç«¯ Dragonfly çš„ shard æ•°é‡ï¼‰
- **æ™ºèƒ½æ‰¹å¤„ç†**ï¼šè‡ªé€‚åº”æ‰¹æ¬¡å¤§å°ï¼ˆé›†ç¾¤æ¨¡å¼ 20Kï¼Œå•æœºæ¨¡å¼ 2Kï¼‰
- **é›†ç¾¤è·¯ç”±ä¼˜åŒ–**ï¼šåŸºäºä¸»èŠ‚ç‚¹åˆ†ç»„è€Œé slot åˆ†ç»„ï¼ˆ100 å€æ€§èƒ½æå‡ï¼‰

### 3. ç”Ÿäº§å°±ç»ª
- **æ–­ç‚¹ç»­ä¼ **ï¼šåŸºäº LSN çš„æ¢å¤æœºåˆ¶
- **å†²çªå¤„ç†**ï¼šå¯é…ç½®ç­–ç•¥ï¼ˆoverwrite/skip/panicï¼‰
- **ç›‘æ§**ï¼šå†…ç½® Dashboard å’ŒæŒ‡æ ‡å¯¼å‡º

## ç³»ç»Ÿæ¶æ„

<!-- ğŸ–¼ï¸ ç³»ç»Ÿæ¶æ„å›¾å ä½ç¬¦ -->
<!-- æ›¿æ¢ä¸ºï¼šdocs/images/architecture/system-overview.png -->
![ç³»ç»Ÿæ¶æ„](../../images/architecture/system-overview.png)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Dragonfly Master (æºç«¯)                       â”‚
â”‚                      N ä¸ª Shard (FLOW 0-N)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ RDB Stream + Journal Stream
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         df2redis                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FLOW å±‚ (N ä¸ª Goroutine)                                â”‚  â”‚
â”‚  â”‚    Reader 0-7ï¼šæ¯ä¸ª FLOW ä¸€ä¸ª TCP è¿æ¥                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Parser å±‚ (N ä¸ª Goroutine)                              â”‚  â”‚
â”‚  â”‚    RDB Parserï¼šOpcode â†’ Entry                            â”‚  â”‚
â”‚  â”‚    Journal Parserï¼šLSN, TxID, Command                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å…¨å±€åŒæ­¥å±éšœ                                            â”‚  â”‚
â”‚  â”‚    ç­‰å¾…æ‰€æœ‰ FLOW å®Œæˆ RDB é˜¶æ®µ                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Writer å±‚ (N ä¸ª Goroutine)                              â”‚  â”‚
â”‚  â”‚    æ‰¹æ¬¡ï¼š20K æ¡ç›®ï¼Œç¼“å†²åŒºï¼š2M æ¡ç›®                       â”‚  â”‚
â”‚  â”‚    é›†ç¾¤è·¯ç”±ï¼šåŸºäºèŠ‚ç‚¹åˆ†ç»„                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Pipeline å‘½ä»¤
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Redis Cluster (ç›®æ ‡ç«¯)                              â”‚
â”‚  Master 1 (Slots 0-5460)                                         â”‚
â”‚  Master 2 (Slots 5461-10922)                                     â”‚
â”‚  Master 3 (Slots 10923-16383)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å…³é”®æ–‡ä»¶ |
|------|-----|---------|
| **FLOW ç®¡ç†å™¨** | å»ºç«‹å’Œç®¡ç† N ä¸ª FLOW è¿æ¥ | `internal/replica/replicator.go` |
| **RDB Parser** | è§£ç  Dragonfly RDB æµ | `internal/replica/rdb_parser.go` |
| **Journal Parser** | è§£æ Journal æ¡ç›® | `internal/replica/journal_parser.go` |
| **é›†ç¾¤è·¯ç”±** | åŸºäºä¸»èŠ‚ç‚¹çš„è·¯ç”± | `internal/replica/flow_writer.go` |
| **Checkpoint ç®¡ç†** | LSN æŒä¹…åŒ– | `internal/state/checkpoint.go` |

## æ•°æ®æµ

```
æ¡æ‰‹ â†’ FLOW å»ºç«‹ â†’ å…¨é‡åŒæ­¥ (RDB) â†’ å±éšœ â†’ ç¨³å®šåŒæ­¥ (Journal)
                                       â”‚
                                       â””â”€â†’ æ‰€æœ‰ FLOW å¿…é¡»å®Œæˆ
```

## å…³é”®åˆ›æ–°

### 1. EOF Token å¤„ç†
**é—®é¢˜**ï¼šDragonfly åœ¨ `FULLSYNC_END` åå‘é€ 40 å­—èŠ‚ SHA1 æ ¡éªŒå’Œï¼Œå¯èƒ½å¯¼è‡´æµè§£æé”™ä½ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæ˜¾å¼è¯»å–å¹¶ä¸¢å¼ƒæ ¡éªŒå’Œï¼Œç¡®ä¿ Journal Parser ä»æ­£ç¡®ä½ç½®å¼€å§‹ã€‚

```go
// è¯»å–å¹¶ä¸¢å¼ƒ EOF Tokenï¼Œé˜²æ­¢ "unknown opcode" é”™è¯¯
eofToken := make([]byte, 40)
io.ReadFull(conn, eofToken)
```

### 2. åŸºäºèŠ‚ç‚¹çš„é›†ç¾¤è·¯ç”±
**é—®é¢˜**ï¼šRedis Cluster æœ‰ 16384 ä¸ª slotã€‚æŒ‰ slot åˆ†ç»„ä¼šå¯¼è‡´ ~2000 ä¸ªå¾®å‹ Pipelineï¼ˆæ¯ä¸ªåªæœ‰ 1 æ¡å‘½ä»¤ï¼‰ï¼Œæ‰¹æ¬¡å¤§å°ä¸º 2000 æ—¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæŒ‰ä¸»èŠ‚ç‚¹åˆ†ç»„è€Œé slotã€‚

```go
// âœ… æ­£ç¡®ï¼šæŒ‰ä¸»èŠ‚ç‚¹åˆ†ç»„
func groupByNode(entries) {
    for entry := range entries {
        slot := crc16(entry.Key) % 16384
        masterAddr := clusterTopology[slot]  // å…³é”®ä¼˜åŒ–
        groups[masterAddr].append(entry)
    }
}

// ç»“æœï¼š3 ä¸ªå¤§ Pipelineï¼ˆæ¯ä¸ª ~666 æ¡å‘½ä»¤ï¼‰
// æ€§èƒ½ï¼š10 ops/sec â†’ 10,000+ ops/sec (1000 å€æå‡)
```

### 3. å…¨å±€åŒæ­¥å±éšœ
**é—®é¢˜**ï¼šDragonfly è¦æ±‚æ‰€æœ‰ FLOW å®Œæˆ RDB æ‰èƒ½è¿›å…¥ç¨³å®šåŒæ­¥ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå®ç°é˜»å¡è®¡æ•°å™¨æ¨¡å¼ã€‚

```go
rdbCompletionBarrier := make(chan struct{})
var rdbCompleteCount atomic.Int32

// æ¯ä¸ª FLOW å®Œæˆæ—¶å‘å‡ºä¿¡å·
if rdbCompleteCount.Add(1) == int32(numFlows) {
    close(rdbCompletionBarrier)  // æœ€åä¸€ä¸ª FLOW è§¦å‘
}

<-rdbCompletionBarrier  // ä¸» Goroutine ç­‰å¾…
sendSTARTSTABLE()       // è¿›å…¥ç¨³å®šåŒæ­¥
```

## æ€§èƒ½ç‰¹æ€§

| æŒ‡æ ‡ | æ•°å€¼ | å¤‡æ³¨ |
|------|-----|------|
| **å…¨é‡åŒæ­¥ååé‡** | 100,000+ ops/sec | é€‚å½“çš„æ‰¹æ¬¡å¤§å° |
| **å¢é‡åŒæ­¥å»¶è¿Ÿ** | <50ms | Journal æ¡ç›®åˆ° Redis |
| **å†…å­˜ä½¿ç”¨** | ~16GB | N FLOWs Ã— 2M buffer Ã— 1KB/entry |
| **CPU ä½¿ç”¨** | ~400% | N parser + N writer goroutines |

## å»¶ä¼¸é˜…è¯»

- [å¤åˆ¶åè®®æ·±åº¦è§£æ](replication-protocol.md)
- [å¤š FLOW æ¶æ„](multi-flow.md)
- [é›†ç¾¤è·¯ç”±ä¼˜åŒ–](cluster-routing.md)
- [æ•°æ®æµæ°´çº¿ä¸èƒŒå‹æ§åˆ¶](data-pipeline.md)
