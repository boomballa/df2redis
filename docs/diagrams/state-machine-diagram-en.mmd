%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'14px', 'fontFamily':'Arial, sans-serif'}}}%%
stateDiagram-v2
    classDef handshakeClass fill:#BBDEFB,stroke:#1976D2,stroke-width:2px,color:#000
    classDef flowClass fill:#C8E6C9,stroke:#388E3C,stroke-width:2px,color:#000
    classDef fullsyncClass fill:#E1BEE7,stroke:#7B1FA2,stroke-width:2px,color:#000
    classDef barrierClass fill:#D1C4E9,stroke:#512DA8,stroke-width:2px,color:#000
    classDef stableClass fill:#B2EBF2,stroke:#00838F,stroke-width:2px,color:#000
    classDef errorClass fill:#CFD8DC,stroke:#455A64,stroke-width:2px,color:#000
    classDef criticalClass fill:#FFE0B2,stroke:#E65100,stroke-width:3px,color:#000

    [*] --> Disconnected: ðŸš€ Start

    note right of Disconnected
        Initial state
        Waiting for connection
    end note

    Disconnected --> Handshake: Connect to Dragonfly

    state Handshake {
        [*] --> SendREPLCONF
        SendREPLCONF --> ReceiveMasterID: REPLCONF capa dragonfly
        ReceiveMasterID --> ExtractParams: Parse response
        ExtractParams --> SendVersion: Extract master_id, session_id, num_flows (N)
        SendVersion --> [*]: REPLCONF version 1
    }
    class Handshake handshakeClass

    Handshake --> FLOWRegistration: âœ… Handshake Success

    state FLOWRegistration {
        [*] --> RegisterFLOWs
        RegisterFLOWs --> AllFLOWsReady: Register N FLOWs (0..N-1)
        AllFLOWsReady --> [*]

        note right of RegisterFLOWs
            N = Dragonfly shard count (typically 8-16)
            Each FLOW maps to one shard
            Command: DFLY FLOW <master_id> <session_id> <flow_id>
        end note
    }
    class FLOWRegistration flowClass

    FLOWRegistration --> FullSync: âœ… N FLOWs Registered

    state FullSync {
        [*] --> SendDFLYSYNC
        SendDFLYSYNC --> ReceiveFULLSYNC: DFLY SYNC <session_id>
        ReceiveFULLSYNC --> ParseRDB: +FULLSYNC response
        ParseRDB --> ConsumeEOF: Opcode 200 (END)
        ConsumeEOF --> ReceiveOffset: Read 40-byte EOF
        ReceiveOffset --> [*]: Opcode 211 (OFFSET)

        note right of ParseRDB
            Parse RDB stream:
            â€¢ Opcode 0-15: Standard RDB
            â€¢ Opcode 210: Inline Journal
            â€¢ Opcode 200: FULLSYNC_END
        end note

        note right of ConsumeEOF
            âš ï¸ Critical: Must read 40-byte SHA1
            Otherwise Journal parser will misread
        end note
    }
    class FullSync fullsyncClass

    FullSync --> GlobalBarrier: âœ… RDB Complete

    state GlobalBarrier {
        [*] --> WaitAllFLOWs
        WaitAllFLOWs --> AllReady: rdbCompleteCount == N
        AllReady --> [*]

        note right of WaitAllFLOWs
            Wait for all N FLOWs to complete RDB
            Atomic counter ensures sync
        end note
    }
    class GlobalBarrier barrierClass

    GlobalBarrier --> StableSync: âœ… Global Sync Complete

    state StableSync {
        [*] --> SendSTARTSTABLE
        SendSTARTSTABLE --> StreamJournal: DFLY STARTSTABLE <sid> <lsn>
        StreamJournal --> StreamJournal: Continuous running

        note right of StreamJournal
            Handle Journal Opcodes:
            â€¢ 6: SELECT (switch DB)
            â€¢ 9: EXPIRED (expiry)
            â€¢ 10: COMMAND (replay)
            â€¢ 13: PING (heartbeat)
            â€¢ 15: LSN (checkpoint)
            Send: REPLCONF ACK <offset>
        end note
    }
    class StableSync stableClass

    state ErrorHandling {
        [*] --> StopHeartbeat
        StopHeartbeat --> WaitInflight: Stop ACK
        WaitInflight --> SendFIN: Wait 2s
        SendFIN --> WaitAck: CloseWrite()
        WaitAck --> FullClose: Wait 1s
        FullClose --> [*]: Close connection
    }
    class ErrorHandling errorClass

    Handshake --> ErrorHandling: âŒ Error
    FLOWRegistration --> ErrorHandling: âŒ Error
    FullSync --> ErrorHandling: âŒ Error
    StableSync --> ErrorHandling: ðŸ›‘ Stop

    ErrorHandling --> Disconnected: ðŸ”„ Reconnect
    ErrorHandling --> [*]: ðŸšª Exit
