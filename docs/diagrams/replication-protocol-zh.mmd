%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'16px', 'fontFamily':'Arial, Microsoft YaHei, sans-serif'}}}%%
sequenceDiagram
    autonumber
    participant C as df2redis å®¢æˆ·ç«¯
    participant D as Dragonfly ä¸»èŠ‚ç‚¹

    rect rgb(220, 237, 250)
        Note over C,D: ğŸ¤ é˜¶æ®µ 1: æ¡æ‰‹ï¼ˆHandshakeï¼‰
        C->>D: REPLCONF listening-port 0
        D-->>C: OK
        C->>D: REPLCONF capa dragonfly
        D-->>C: [master_id, session_id, num_flows, version]
        C->>D: REPLCONF version 1
        D-->>C: OK
    end

    rect rgb(220, 250, 230)
        Note over C,D: ğŸ”Œ é˜¶æ®µ 2: FLOW æ³¨å†Œ
        Note over C: N = num_flowsï¼ˆé€šå¸¸ 8-16ï¼Œå–å†³äºåˆ†ç‰‡æ•°ï¼‰
        loop ä¸ºæ¯ä¸ª FLOW (0..N-1)
            C->>D: DFLY FLOW <master_id> <session_id> <flow_id>
            D-->>C: +OK
        end
    end

    rect rgb(255, 243, 224)
        Note over C,D: ğŸ“¦ é˜¶æ®µ 3: å…¨é‡åŒæ­¥ï¼ˆFull Syncï¼‰
        C->>D: DFLY SYNC <session_id>
        D-->>C: +FULLSYNC

        Note over C,D: RDB æ•°æ®ä¼ è¾“ï¼ˆæ‰€æœ‰ FLOW å¹¶è¡Œï¼‰
        D->>C: RDB Stream (Opcode 0-15)
        D->>C: JOURNAL_BLOB (Opcode 210)
        D->>C: ...æ›´å¤š RDB æ•°æ®...
        D->>C: FULLSYNC_END (Opcode 200)
    end

    rect rgb(255, 230, 230)
        Note over C: âš ï¸ å…³é”®ï¼šè¯»å– 40 å­—èŠ‚ EOF Token
        D->>C: 40-byte SHA1 Checksum (EOF)
        Note over C: consumeEOFToken()<br/>å¿…é¡»æ˜¾å¼è¯»å–å¹¶ä¸¢å¼ƒï¼
    end

    rect rgb(255, 243, 224)
        D->>C: JOURNAL_OFFSET (Opcode 211)
    end

    rect rgb(243, 229, 245)
        Note over C,D: ğŸš§ é˜¶æ®µ 4: å…¨å±€å±éšœï¼ˆGlobal Barrierï¼‰
        Note over C: ç­‰å¾…æ‰€æœ‰ FLOW å®Œæˆ RDB é˜¶æ®µ<br/>æ¡ä»¶ï¼šrdbCompleteCount == numFlows<br/>åŸå­è®¡æ•°å™¨ç¡®ä¿åŒæ­¥
    end

    rect rgb(224, 247, 250)
        Note over C,D: ğŸ”„ é˜¶æ®µ 5: ç¨³å®šåŒæ­¥ï¼ˆStable Syncï¼‰
        C->>D: DFLY STARTSTABLE <session_id> <lsn>
        D-->>C: OK

        Note over C,D: Journal æµå¼ä¼ è¾“ï¼ˆæŒç»­è¿›è¡Œï¼‰
        loop æ— é™å¾ªç¯ - å®æ—¶åŒæ­¥
            D->>C: Journal Entry (Opcode 6/9/10/13/15)
            Note over C: è§£æå¹¶é‡æ”¾å‘½ä»¤åˆ° Redis<br/>è·Ÿè¸ªçœŸå®å­—èŠ‚åç§»é‡
            C->>D: REPLCONF ACK <offset>
            Note over D: æ¥æ”¶ ACKï¼Œæ›´æ–°å‰¯æœ¬çŠ¶æ€
        end
    end

    rect rgb(255, 240, 245)
        Note over C,D: ğŸ’¡ ä¼˜é›…å…³é—­æµç¨‹
        Note over C: 1. åœæ­¢å‘é€ ACK (2s)<br/>2. CloseWrite() å‘é€ FIN<br/>3. ç­‰å¾…ç¡®è®¤ (1s)<br/>4. å®Œå…¨å…³é—­è¿æ¥
    end
