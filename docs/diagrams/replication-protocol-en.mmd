%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'16px', 'fontFamily':'Arial, sans-serif'}}}%%
sequenceDiagram
    autonumber
    participant C as df2redis Client
    participant D as Dragonfly Master

    rect rgb(187, 222, 251)
        Note over C,D: ðŸ¤ Phase 1: Handshake
        C->>D: REPLCONF listening-port 0
        D-->>C: OK
        C->>D: REPLCONF capa dragonfly
        D-->>C: [master_id, session_id, num_flows, version]
        C->>D: REPLCONF version 1
        D-->>C: OK
    end

    rect rgb(200, 230, 201)
        Note over C,D: ðŸ”Œ Phase 2: FLOW Registration
        Note over C: N = num_flows (typically 8-16, depends on shard count)
        loop For each FLOW (0..N-1)
            C->>D: DFLY FLOW <master_id> <session_id> <flow_id>
            D-->>C: +OK
        end
    end

    rect rgb(225, 190, 231)
        Note over C,D: ðŸ“¦ Phase 3: Full Sync
        C->>D: DFLY SYNC <session_id>
        D-->>C: +FULLSYNC

        Note over C,D: RDB Data Transfer (All FLOWs in Parallel)
        D->>C: RDB Stream (Opcode 0-15)
        D->>C: JOURNAL_BLOB (Opcode 210)
        D->>C: ...more RDB data...
        D->>C: FULLSYNC_END (Opcode 200)
    end

    rect rgb(255, 224, 178)
        Note over C: âš ï¸ Critical: Read 40-byte EOF Token
        D->>C: 40-byte SHA1 Checksum (EOF)
        Note over C: consumeEOFToken()<br/>Must explicitly read and discard!
    end

    rect rgb(225, 190, 231)
        D->>C: JOURNAL_OFFSET (Opcode 211)
    end

    rect rgb(209, 196, 233)
        Note over C,D: ðŸš§ Phase 4: Global Barrier
        Note over C: Wait for all FLOWs to complete RDB<br/>Condition: rdbCompleteCount == numFlows<br/>Atomic counter ensures sync
    end

    rect rgb(178, 235, 242)
        Note over C,D: ðŸ”„ Phase 5: Stable Sync
        C->>D: DFLY STARTSTABLE <session_id> <lsn>
        D-->>C: OK

        Note over C,D: Journal Streaming (Continuous)
        loop Infinite Loop - Real-time Sync
            D->>C: Journal Entry (Opcode 6/9/10/13/15)
            Note over C: Parse and replay to Redis<br/>Track real byte offsets
            C->>D: REPLCONF ACK <offset>
            Note over D: Receive ACK, update replica state
        end
    end

    rect rgb(207, 216, 220)
        Note over C,D: ðŸ’¡ Graceful Shutdown Process
        Note over C: 1. Stop sending ACK (2s)<br/>2. CloseWrite() send FIN<br/>3. Wait for ack (1s)<br/>4. Fully close connection
    end
