{{ define "content" }}
<div class="hero">
    <div>
        <h1>df2redis Live Dashboard</h1>
        <p class="subtitle">Track Dragonfly ‚Üí Redis synchronization at a glance.</p>
    </div>

    {{ if .TaskName }}
    <!-- Task Module -->
    <div class="meta-section">
        <div class="meta-section-title">
            <span class="section-icon">üè∑Ô∏è</span>
            <span>Task Information</span>
        </div>
        <div class="meta-row">
            <div class="meta-pill task-pill">
                <span>Task: <strong>{{ .TaskName }}</strong></span>
            </div>
            <div class="meta-pill">
                <span class="icon">‚è±Ô∏è</span>
                <span>Updated: <strong>{{ .GeneratedAt }}</strong></span>
            </div>
        </div>
    </div>
    {{ end }}

    <!-- Data Source Module -->
    <div class="meta-section">
        <div class="meta-section-title">
            <span class="section-icon">üîÑ</span>
            <span>Data Source Configuration</span>
        </div>
        <div class="meta-row">
            <div class="meta-pill">
                <span class="icon">üóÑÔ∏è</span>
                <span>Source: <strong>{{ .Source.Type }} @ {{ .Source.Addr }}</strong></span>
            </div>
            <div class="meta-pill">
                <span class="icon">üéØ</span>
                <span>Target: <strong>{{ .Target.Type }} @ {{ .Target.Addr }}</strong></span>
            </div>
        </div>
    </div>

    <!-- Storage & Logs Module -->
    <div class="meta-section">
        <div class="meta-section-title">
            <span class="section-icon">üíæ</span>
            <span>Storage & Logs</span>
        </div>
        <div class="meta-row">
            <div class="meta-pill">
                <span class="icon">üóÇÔ∏è</span>
                <span>State: <strong>{{ .StateDir }}</strong></span>
            </div>
            <div class="meta-pill">
                <span class="icon">üìù</span>
                <span>Status: <strong>{{ .StatusFile }}</strong></span>
            </div>
            {{ if .LogFile }}
            <div class="meta-pill">
                <span class="icon">üìã</span>
                <span>Logs: <strong>{{ .LogFile }}</strong></span>
            </div>
            {{ end }}
        </div>
    </div>
</div>

<div class="grid grid-3" style="margin-top:24px;">
    <div class="card highlight">
        <div class="card-title">Sync Status</div>
        <div class="state-badge" id="pipeline-status">{{ with .Snapshot }}{{ .PipelineStatus }}{{ else }}pending{{ end }}</div>
        <p class="muted" style="margin-top:12px;">Current stage: <strong id="current-stage">incremental</strong></p>
        <p class="muted">Last refresh: <span id="pipeline-updated">{{ with .Snapshot }}{{ .UpdatedAt }}{{ else }}--{{ end }}</span></p>
    </div>
    <div class="card">
        <div class="card-title">Source</div>
        <p class="muted">Type: <strong>{{ .Source.Type }}</strong></p>
        <p class="muted">Addr: <strong>{{ .Source.Addr }}</strong></p>
        <p class="muted">TLS: {{ if .Source.TLS }}enabled{{ else }}disabled{{ end }}</p>
    </div>
    <div class="card">
        <div class="card-title">Target</div>
        <p class="muted">Type: <strong>{{ .Target.Type }}</strong></p>
        <p class="muted">Addr: <strong>{{ .Target.Addr }}</strong></p>
        <p class="muted">TLS: {{ if .Target.TLS }}enabled{{ else }}disabled{{ end }}</p>
    </div>
</div>

<div class="grid grid-2" style="margin-top:24px;">
    <section class="card highlight">
        <div class="card-title">Metrics overview</div>
        <div class="metrics-grid" id="metrics-list" style="margin-top:0;">
            {{ with .Snapshot }}
            {{ range $k, $v := .Metrics }}
            <div class="metric-item">
                <div class="label">{{ $k }}</div>
                <div class="value">{{ printf "%.4f" $v }}</div>
            </div>
            {{ end }}
            {{ else }}
            <p class="muted">No metrics yet.</p>
            {{ end }}
        </div>
    </section>

    <section class="card">
        <div class="card-title">Stage progress</div>
        <table class="table" id="stages-table">
            <thead><tr><th>Stage</th><th>Status</th><th>Updated</th><th>Message</th></tr></thead>
            <tbody>
            {{ with .Snapshot }}
            {{ range $name, $st := .Stages }}
            <tr class="stage-row">
                <td>{{ $name }}</td>
                <td><span class="badge">{{ $st.Status }}</span></td>
                <td>{{ $st.UpdatedAt }}</td>
                <td>{{ $st.Message }}</td>
            </tr>
            {{ end }}
            {{ else }}
            <tr><td colspan="4" class="muted">No stage data.</td></tr>
            {{ end }}
            </tbody>
        </table>
    </section>
</div>

<!-- Performance Monitoring Section -->
<div class="grid grid-2" style="margin-top:24px;">
    <section class="card highlight">
        <div class="card-title">‚ö° QPS Performance</div>
        <div class="metrics-grid" style="margin-top:12px; margin-bottom:16px;">
            <div class="metric-item">
                <div class="label">Current QPS</div>
                <div class="value" id="qps-current">--</div>
            </div>
            <div class="metric-item">
                <div class="label">Peak QPS</div>
                <div class="value" id="qps-peak">--</div>
            </div>
            <div class="metric-item">
                <div class="label">Avg QPS</div>
                <div class="value" id="qps-avg">--</div>
            </div>
        </div>
        <div style="height:200px; position:relative;">
            <canvas id="qps-chart"></canvas>
        </div>
    </section>

    <section class="card">
        <div class="card-title">üïê Batch Write Latency</div>
        <div class="metrics-grid" style="margin-top:12px; margin-bottom:16px;">
            <div class="metric-item">
                <div class="label">P50</div>
                <div class="value" id="latency-p50">--</div>
            </div>
            <div class="metric-item">
                <div class="label">P95</div>
                <div class="value" id="latency-p95">--</div>
            </div>
            <div class="metric-item">
                <div class="label">P99</div>
                <div class="value" id="latency-p99">--</div>
            </div>
            <div class="metric-item">
                <div class="label">Avg</div>
                <div class="value" id="latency-avg">--</div>
            </div>
            <div class="metric-item">
                <div class="label">Max</div>
                <div class="value" id="latency-max">--</div>
            </div>
        </div>
        <div class="perf-info" style="padding:12px; background:rgba(59,130,246,0.1); border-radius:8px; border-left:3px solid #3b82f6;">
            <p style="color:#94a3b8; font-size:13px; line-height:1.6;">
                <strong style="color:#3b82f6;">Note:</strong> Latency measured in milliseconds (ms).
                Represents batch write operation time from submission to completion.
            </p>
        </div>
    </section>
</div>

<div class="grid grid-2" style="margin-top:24px;">
    <section class="card">
        <div class="card-title">Sync Flow Visualization</div>
        <div class="flow-diagram" id="flow-diagram">
            <div class="flow-step" data-status="completed">
                <div class="flow-node">
                    <div class="flow-header">
                        <div class="flow-icon">ü§ù</div>
                        <div class="flow-label">Handshake</div>
                    </div>
                    <div class="flow-description">Establishing connection with Dragonfly</div>
                    <div class="flow-status">Status: <span class="status-text">Completed ‚úì</span></div>
                </div>
                <div class="flow-connector"></div>
            </div>
            <div class="flow-step" data-status="completed">
                <div class="flow-node">
                    <div class="flow-header">
                        <div class="flow-icon">üì¶</div>
                        <div class="flow-label">RDB Snapshot</div>
                    </div>
                    <div class="flow-description">Full data transfer from source</div>
                    <div class="flow-status">Imported: <span class="status-value">--</span> keys</div>
                </div>
                <div class="flow-connector"></div>
            </div>
            <div class="flow-step" data-status="active">
                <div class="flow-node">
                    <div class="flow-header">
                        <div class="flow-icon">üìù</div>
                        <div class="flow-label">Journal Stream (Continuous)</div>
                    </div>
                    <div class="flow-description">Real-time incremental replication</div>
                    <div class="flow-status">Applied: <span class="status-value" data-metric="sync.incremental.ops.success">--</span> operations</div>
                </div>
                <div class="flow-connector"></div>
            </div>
            <div class="flow-step" data-status="pending">
                <div class="flow-node">
                    <div class="flow-header">
                        <div class="flow-icon">‚úÖ</div>
                        <div class="flow-label">Sync Complete</div>
                    </div>
                    <div class="flow-description">Manually stopped by user</div>
                    <div class="flow-status">Status: <span class="status-text">Standby</span></div>
                </div>
            </div>
        </div>
    </section>

    <section class="card">
        <div class="card-title">Errors & Warnings</div>
        <div class="errors-warnings" id="errors-warnings">
            {{ with .Snapshot }}
            <div class="error-warning-section">
                <div class="error-warning-header">
                    <span class="error-warning-icon error-icon">‚úó</span>
                    <span class="error-warning-label">Failed Commands</span>
                    <span class="error-warning-count" id="failed-count">{{ if .Metrics }}{{ index .Metrics "sync.incremental.ops.failed" }}{{ else }}0{{ end }}</span>
                </div>
                <div class="error-warning-body" id="failed-details">
                    <p class="muted">Command execution failures (MOVED, timeout, etc.)</p>
                </div>
            </div>

            <div class="error-warning-section">
                <div class="error-warning-header">
                    <span class="error-warning-icon warning-icon">‚ö†</span>
                    <span class="error-warning-label">Skipped Commands</span>
                    <span class="error-warning-count" id="skipped-count">{{ if .Metrics }}{{ index .Metrics "sync.incremental.ops.skipped" }}{{ else }}0{{ end }}</span>
                </div>
                <div class="error-warning-body" id="skipped-details">
                    <p class="muted">Commands skipped (SELECT, PING, global commands)</p>
                </div>
            </div>

            <div class="error-warning-section success-section">
                <div class="error-warning-header">
                    <span class="error-warning-icon success-icon">‚úì</span>
                    <span class="error-warning-label">Status</span>
                </div>
                <div class="error-warning-body">
                    <p class="success-text" id="status-summary">All systems operational</p>
                </div>
            </div>
            {{ else }}
            <p class="muted">No data available.</p>
            {{ end }}
        </div>
    </section>
</div>

<section class="card" id="live-logs-card" style="margin-top:24px;">
    <div class="card-title">
        Live Logs
        <span class="log-auto-refresh-indicator" id="auto-refresh-indicator">
            <span class="refresh-dot"></span> Auto-refresh ON
        </span>
    </div>

    <div class="log-controls">
        <div class="log-search">
            <input type="text" id="log-search-input" placeholder="Search logs..." class="log-search-input">
            <button id="log-search-btn" class="log-control-btn">
                <span>üîç</span> Search
            </button>
            <button id="log-search-clear" class="log-control-btn" style="display:none;">
                <span>‚úó</span> Clear
            </button>
        </div>
        <div class="log-actions">
            <button id="log-jump-top-btn" class="log-control-btn">
                <span>‚á°</span> Top
            </button>
            <button id="log-refresh-btn" class="log-control-btn">
                <span>üîÑ</span> Refresh
            </button>
            <button id="log-scroll-bottom-btn" class="log-control-btn">
                <span>‚Üì</span> Scroll
            </button>
            <button id="log-jump-latest-btn" class="log-control-btn">
                <span>‚á£‚á£</span> Latest
            </button>
            <button id="log-pause-resume-btn" class="log-control-btn">
                <span>‚è∏</span> Pause
            </button>
        </div>
    </div>

    <!-- Top navigation: Load earlier logs -->
    <div class="log-footer" id="log-header" style="margin-bottom: 0.5rem;">
        <button id="log-load-earlier-btn" class="log-load-more-btn" style="display: none;">
            ‚¨Ü Load 50 Earlier Lines
        </button>
    </div>

    <div class="log-viewer" id="log-viewer">
        <div class="log-content" id="log-content">
            <div class="log-loading">Loading logs...</div>
        </div>
    </div>

    <!-- Bottom navigation: Load newer logs -->
    <div class="log-footer">
        <button id="log-load-newer-btn" class="log-load-more-btn" style="display: none;">
            ‚¨á Load 50 Newer Lines
        </button>
        <div class="log-status" id="log-status">
            Showing <span id="log-shown-count">0</span> of <span id="log-total-count">0</span> lines
        </div>
    </div>
</section>

<section class="card" id="check-validation-card" style="margin-top:24px;">
    <div class="card-title">üìä Data Validation</div>

    <div class="check-config-form">
        <div class="check-form-row">
            <div class="check-form-group">
                <label class="check-label" for="check-compare-mode">Compare Mode</label>
                <select id="check-compare-mode" class="check-input">
                    <option value="2">Length Only (Fast)</option>
                    <option value="1">Full Value (Accurate)</option>
                    <option value="4">Smart (Auto)</option>
                    <option value="3">Key Outline (Fastest)</option>
                </select>
                <span class="check-hint">Comparison precision: length, full value, smart, or key outline</span>
            </div>
            <div class="check-form-group">
                <label class="check-label" for="check-compare-times">Compare Rounds</label>
                <input type="number" id="check-compare-times" class="check-input" value="3" min="1" max="10">
                <span class="check-hint">Number of validation rounds to handle sync delays</span>
            </div>
        </div>

        <div class="check-form-row">
            <div class="check-form-group">
                <label class="check-label" for="check-qps">QPS Limit</label>
                <input type="number" id="check-qps" class="check-input" value="5000" min="1" max="50000">
                <span class="check-hint">Max queries per second</span>
            </div>
            <div class="check-form-group">
                <label class="check-label" for="check-batch-count">Batch Size</label>
                <input type="number" id="check-batch-count" class="check-input" value="256" min="1" max="10000">
                <span class="check-hint">Number of keys per batch</span>
            </div>
        </div>

        <div class="check-form-row">
            <div class="check-form-group">
                <label class="check-label" for="check-parallel">Parallel</label>
                <input type="number" id="check-parallel" class="check-input" value="2" min="1" max="100">
                <span class="check-hint">Number of concurrent workers</span>
            </div>
        </div>

        <div class="check-actions">
            <button id="check-start-btn" class="check-btn check-btn-primary">
                <span>‚ñ∂</span> Start Validation
            </button>
            <button id="check-stop-btn" class="check-btn check-btn-danger" style="display:none;">
                <span>‚èπ</span> Stop
            </button>
        </div>
    </div>

    <div class="check-progress-panel" id="check-progress-panel" style="display:none;">
        <div class="check-progress-header">
            <div class="check-progress-title">
                Validation Progress
                <span id="check-round-indicator" style="margin-left: 8px; font-size: 0.9em; color: #3b82f6;">Round 1/3</span>
            </div>
            <div class="check-progress-status" id="check-status-text">Initializing...</div>
        </div>

        <div class="check-progress-bar-container">
            <div class="check-progress-bar" id="check-progress-bar" style="width: 0%;"></div>
            <div class="check-progress-percent" id="check-progress-percent">0%</div>
        </div>

        <div class="check-stats-grid">
            <div class="check-stat-item">
                <div class="check-stat-icon check-stat-checked">‚úì</div>
                <div class="check-stat-label">Consistent</div>
                <div class="check-stat-value" id="check-consistent-count">0</div>
            </div>
            <div class="check-stat-item">
                <div class="check-stat-icon check-stat-inconsistent">‚úó</div>
                <div class="check-stat-label">Inconsistent</div>
                <div class="check-stat-value" id="check-inconsistent-count">0</div>
            </div>
            <div class="check-stat-item">
                <div class="check-stat-icon check-stat-error">‚ö†</div>
                <div class="check-stat-label">Errors</div>
                <div class="check-stat-value" id="check-error-count">0</div>
            </div>
            <div class="check-stat-item">
                <div class="check-stat-icon check-stat-time">‚è±</div>
                <div class="check-stat-label">Elapsed</div>
                <div class="check-stat-value" id="check-elapsed-time">0s</div>
            </div>
        </div>
    </div>

    <!-- Inconsistent Keys Sample Display -->
    <div id="inconsistent-samples-panel" style="display:none; margin-top:24px;">
        <div class="card-title" style="margin-bottom:12px;">
            üîç Inconsistent Keys
            <span id="sample-count-badge" style="font-size:0.85em; color:#f59e0b; margin-left:8px;">
                (showing <span id="shown-sample-count">0</span> of <span id="total-sample-count">0</span>)
            </span>
        </div>
        <div style="overflow-x:auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width:40%;">Key</th>
                        <th style="width:30%;">Source Value</th>
                        <th style="width:30%;">Target Value</th>
                    </tr>
                </thead>
                <tbody id="inconsistent-samples-tbody">
                    <!-- Dynamically populated -->
                </tbody>
            </table>
        </div>
        <div style="margin-top:12px; padding:10px; background:rgba(239,68,68,0.1); border-radius:6px; border-left:3px solid #ef4444;">
            <p style="color:#94a3b8; font-size:13px; line-height:1.6;">
                <strong style="color:#ef4444;">Warning:</strong> These samples represent data inconsistencies detected during validation.
                Limited to first 100 samples for performance. Check result files for complete list.
            </p>
        </div>
    </div>
</section>

{{ end }}

{{ define "scripts" }}{{ end }}
